name: Full Check Suite

on:
  push:
  schedule:
    - cron: '0 5 * * *'

concurrency:
  group: qb-${{ github.ref }}
  cancel-in-progress: true

env:
  REPORT_PATH: 'ci/cuke-report.json'
  CUCUMBER_SPLIT_CONFIGURATION_PATH: 'ci/cucumber-split-config.json'
  CLIENT: 'dc'

jobs:
  setup-ruby-node:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          rubygems: 3.3.26
          bundler-cache: true
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '14'
      - name: Cache Ruby Gems and Node modules
        uses: actions/cache@v3
        with:
          path: |
            vendor/bundle
            node_modules
          key: ruby-node-${{ hashFiles('**/Gemfile.lock', '**/yarn.lock') }}
      - name: Zip dependencies
        run: zip -r dependencies.zip vendor/bundle node_modules
      - uses: actions/upload-artifact@v2
        with:
          name: dependencies
          path: dependencies.zip

  view_linter:
    needs: setup-ruby-node
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Download dependencies artifact
        uses: actions/download-artifact@v2
        with:
          name: dependencies
          path: .

      - name: Unzip dependencies
        run: unzip dependencies.zip

      - name: Debugging Information
        run: |
          echo "Listing current directory:"
          ls -lah
          echo "Listing vendor/bundle directory:"
          ls -lah vendor/bundle
          echo "Listing node_modules directory:"
          ls -lah node_modules
          echo "Checking Ruby version:"
          ruby -v
          echo "Checking Bundler version:"
          bundle -v

      - name: Fetch Trunk
        run: git fetch --no-tags --depth=1 origin trunk

      - name: Run View Linter
        run: bundle exec rake view_translations_linter:lint_git_difference_changed_lines
  
